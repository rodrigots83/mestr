---
title: "Passo a passo - Evasão Correntistas"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

Instalação e importação dos pacotes

```{r message=FALSE}

# install.packages("ggplot2")
# install.packages("data.table")
# install.packages("stargazer")
# install.packages("skimr")

library(ggplot2)
library(data.table)
library(stargazer)
library(skimr)
library(readxl)
library(dplyr)

```

Criação da função que gera os gráficos.

```{r message=FALSE}

### FUNÇÃO
box_plot = function(data, atributos, atributosSubgrupo, variavelDependente = 'Evadiu_formatado'){
  for (atributo in atributos) {
    if(length(atributosSubgrupo) > 0){
      for (atributo2 in atributosSubgrupo){
      result = ggplot(data = dtAmostra, aes_string(variavelDependente, atributo)) +
        geom_boxplot(aes_string(fill = atributo2)) +
        # geom_boxplot() +
        labs(x = variavelDependente,
             y = atributo,
             title = "Boxplot",
             subtitle = paste(atributo, variavelDependente, sep = " vs "),
             caption = "") +
        theme_bw() 
        # facet_wrap(~ atributo2)
      print(result)
     }
    }
    else{
      result = ggplot(data = dtAmostra, aes_string(variavelDependente, atributo)) +
        geom_boxplot() +
        labs(x = variavelDependente,
             y = atributo,
             title = "Boxplot",
             subtitle = paste(atributo, variavelDependente, sep = " vs "),
             caption = "") +
        theme_bw() 
        # facet_wrap(~ atributo2)
      print(result)      
    }
  }
}

```

Leitura do arquivo feita e análise dos dados

```{r message=FALSE}

dtAmostra <- fread("dadosBanco/Amostra_Modelo_Evasao_Correntistas_v3.csv")

str(dtAmostra)

```

Como é possível verificar, existem uma série de dados que são caracterizados como inteiro, porém na verdade são variáveis que servem para *classificar* um determinado cliente.

Dessa forma, as variáveis foram transformadas em *fatores*.

```{r message=FALSE}

dtAmostra$Evadiu <- as.factor(dtAmostra$Evadiu)
dtAmostra$Debito_Automatico <- as.factor(dtAmostra$Debito_Automatico)
dtAmostra$Credito_Salario <- as.factor(dtAmostra$Credito_Salario)
dtAmostra$Credenciamento <- as.factor(dtAmostra$Credenciamento)
dtAmostra$Caixa_Seguradora <- as.factor(dtAmostra$Caixa_Seguradora)
dtAmostra$Pediu_Portabilidade <- as.factor(dtAmostra$Pediu_Portabilidade)
dtAmostra$Abriu_Reclamacao <- as.factor(dtAmostra$Abriu_Reclamacao)
dtAmostra$Debito_Automatico_DIF <- as.factor(dtAmostra$Debito_Automatico_DIF)
dtAmostra$Credito_Salario_DIF <- as.factor(dtAmostra$Credito_Salario_DIF)
dtAmostra$Caixa_Seguradora_DIF <- as.factor(dtAmostra$Caixa_Seguradora_DIF)

dtAmostra = dtAmostra %>% mutate(Evadiu_formatado = ifelse(Evadiu == 1, "Sim", "Não")) 

str(dtAmostra)

```

A variável **Pediu_Portabilidade** possui um valor constante e, por conta disso, foi retirada.

Como o interesse é buscar predizer a variável **Evadiu**, verificamos todas as outras variáveis em conjunto com a variável alvo para verificar o resultado. 

No entanto, nos deparamos com algo do tipo:

```{r message=FALSE}

box_plot(credit, c("Aplicacao"), NULL)

```

Ou seja, existem outliers com valores muito altos e que, na verdade, não estão dentro da maioria dos dados relevantes (75%).

Assim, aplicamos uma função chamada *winsor* que tem a função de eliminar esses outliers, como foi feito abaixo:

```{r message=FALSE}

dtAmostra = dtAmostra %>% 
  mutate(winsored_Rentabilidade_PERC = psych::winsor(Rentabilidade_PERC, 0.1)) %>%
  mutate(winsored_Produtos = psych::winsor(Produtos, 0.01)) %>%
  mutate(winsored_Produtos_Qualificados_PERC = psych::winsor(Produtos_Qualificados_PERC, 0.01)) %>%
  mutate(winsored_Produtos_PERC = psych::winsor(Produtos_PERC, 0.01)) %>%
  mutate(winsored_Movimentacoes = psych::winsor(Movimentacoes, 0.1)) %>%
  mutate(winsored_Movimentacoes_Anterior = psych::winsor(Movimentacoes_Anterior, 0.1)) %>%
  mutate(winsored_Movimentacoes_DIF = psych::winsor(Movimentacoes_DIF, 0.1)) %>%
  mutate(winsored_Movimentacoes_PERC = psych::winsor(Movimentacoes_PERC, 0.1)) %>%
  mutate(winsored_Aplicacao = psych::winsor(Aplicacao, 0.1)) %>%
  mutate(winsored_Aplicacao_Anterior = psych::winsor(Aplicacao_Anterior, 0.1)) %>%
  mutate(winsored_Aplicacao_DIF = psych::winsor(Aplicacao_DIF, 0.1)) %>% 
  mutate(winsored_Aplicacao_PERC = psych::winsor(Aplicacao_PERC, 0.1)) %>% 
  mutate(winsored_Credito = psych::winsor(Credito, 0.1)) %>% 
  mutate(winsored_Credito_Anterior = psych::winsor(Credito_Anterior, 0.1)) %>% 
  mutate(winsored_Credito_DIF = psych::winsor(Credito_DIF, 0.1)) %>% 
  mutate(winsored_Credito_PERC = psych::winsor(Credito_PERC, 0.1)) %>% 
  mutate(winsored_Rentabilidade = psych::winsor(Rentabilidade, 0.1)) %>% 
  mutate(winsored_Rentabilidade_Anterior = psych::winsor(Rentabilidade_Anterior, 0.1)) %>% 
  mutate(winsored_Rentabilidade_DIF = psych::winsor(Rentabilidade_DIF, 0.1)) %>% 
  mutate(winsored_Rentabilidade_PERC = psych::winsor(Rentabilidade_PERC, 0.1))

```

Feito isso, rodamos novamente os gráficos para verificarmos quais das variáveis mais seria interessante de se usar como preditora da variável alvo.

Segue resultado abaixo:

```{r message=FALSE}

variaveisIniciais <- c("Produtos",
                       "Produtos_Anterior",
                       "Produtos_DIF",
                       "winsored_Produtos_Qualificados_PERC",
                       "Produtos_Qualificados_DIF",
                       "Produtos_Qualificados_Anterior",
                       "Produtos_Qualificados",
                       "winsored_Produtos_PERC",
                       "winsored_Aplicacao",
                       "winsored_Aplicacao_Anterior",
                       "winsored_Aplicacao_PERC", 
                       "winsored_Aplicacao_DIF",
                       "winsored_Movimentacoes",
                       "winsored_Movimentacoes_DIF",
                       "winsored_Movimentacoes_PERC", 
                       "winsored_Movimentacoes_Anterior", 
                       "winsored_Credito", 
                       "winsored_Credito_Anterior", 
                       "winsored_Credito_PERC", 
                       "winsored_Credito_DIF", 
                       "winsored_Rentabilidade", 
                       "winsored_Rentabilidade_DIF", 
                       "winsored_Rentabilidade_Anterior", 
                       "winsored_Rentabilidade_PERC")

box_plot(credit, variaveisIniciais, NULL)

```

É interessante colocar também que aquelas variáveis que foram identificadas como fatores não tiveram um bom relacionamento a preditora, assim foram utilizadas como uma *terceira variável de análise (visão)* em conjunto com aquelas variáveis que tiveram um melhor resultado na predição:

```{r message=FALSE}

variaveisSubgrupo <- c("Segmento", "Credenciamento", "Caixa_Seguradora", "Caixa_Seguradora_DIF", "Credito_Salario", "Debito_Automatico", "Credito_Salario_DIF", "Debito_Automatico_DIF")

box_plot(credit, c("winsored_Movimentacoes", "Produtos_Qualificados", "winsored_Aplicacao_PERC", "winsored_Credito_DIF"), variaveisSubgrupo)

```

<!-- #  -->
<!-- # box_plot(credit, c("Produtos_Qualificados"), variaveisSubgrupo) -->
<!-- # box_plot(credit, c("winsored_Movimentacoes"), variaveisSubgrupo) -->
<!-- # box_plot(credit, c("winsored_Aplicacao"), variaveisSubgrupo) -->
<!-- # box_plot(credit, c("winsored_Movimentacoes_PERC"), variaveisSubgrupo) -->
<!-- # box_plot(credit, c("winsored_Rentabilidade"), variaveisSubgrupo) -->
<!-- #  -->
<!-- # variaveis1 <- c("Abriu_Reclamacao",  -->
<!-- #                 "Produtos_Qualificados",  -->
<!-- #                 "Produtos_Qualificados_Anterior",  -->
<!-- #                 "Produtos_Qualificados_DIF",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Produtos_Qualificados_PERC",  -->
<!-- #                  -->
<!-- #                 #NÃO TROUXE RESULTADOS BONS -->
<!-- #                 "Produtos", -->
<!-- #                  -->
<!-- #                 ##NÃO TROUXE RESULTADOS BONS -->
<!-- #                 "Produtos_Anterior",  -->
<!-- #                 "Produtos_DIF",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSORED -->
<!-- #                 "Produtos_PERC",  -->
<!-- #                 "Movimentacoes",  -->
<!-- #                 "Movimentacoes_Anterior",  -->
<!-- #                  -->
<!-- #                 ##NÃO TROUXE RESULTADOS BONS -->
<!-- #                 "Movimentacoes_DIF", -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Movimentacoes_PERC",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Aplicacao",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Aplicacao_Anterior", -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Aplicacao_DIF",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Aplicacao_PERC",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Credito",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Credito_Anterior",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Credito_DIF",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Credito_PERC",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Rentabilidade",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Rentabilidade_Anterior",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Rentabilidade_DIF",  -->
<!-- #                  -->
<!-- #                 ## USAR WINSOR -->
<!-- #                 "Rentabilidade_PERC") -->
<!-- #  -->
<!-- # copiaVariaveis1Winsored <- c("Produtos_Qualificados",  -->
<!-- #                               "winsored_Produtos_Qualificados_PERC", -->
<!-- #                               "Produtos_DIF",  -->
<!-- #                               "winsored_Produtos_PERC",  -->
<!-- #                               "winsored_Movimentacoes",  -->
<!-- #                               "winsored_Movimentacoes_PERC",  -->
<!-- #                               "winsored_Credito",  -->
<!-- #                               "winsored_Credito_Anterior",  -->
<!-- #                               "winsored_Rentabilidade",  -->
<!-- #                               "winsored_Rentabilidade_Anterior") -->
<!-- #  -->
<!-- # variaveis2 <- c('winsored_Aplicacao', -->
<!-- #                  'winsored_Aplicacao_Anterior', -->
<!-- #                  'winsored_Aplicacao_DIF', -->
<!-- #                  'winsored_Aplicacao_PERC', -->
<!-- #                  'winsored_Credito', -->
<!-- #                  'winsored_Credito_Anterior', -->
<!-- #                  'winsored_Credito_DIF', -->
<!-- #                  'winsored_Credito_PERC', -->
<!-- #                  'winsored_Rentabilidade', -->
<!-- #                  'winsored_Rentabilidade_Anterior', -->
<!-- #                  'winsored_Rentabilidade_DIF', -->
<!-- #                  'winsored_Rentabilidade_PERC') -->
<!-- #  -->
<!-- # ### FUNÇÃO -->
<!-- # box_plot = function(data, atributos, atributosSubgrupo, variavelDependente = 'Evadiu_formatado'){ -->
<!-- #   for (atributo in atributos) { -->
<!-- #     if(length(atributosSubgrupo) > 0){ -->
<!-- #       for (atributo2 in atributosSubgrupo){ -->
<!-- #       result = ggplot(data = dtAmostra, aes_string(variavelDependente, atributo)) + -->
<!-- #         geom_boxplot(aes_string(fill = atributo2)) + -->
<!-- #         # geom_boxplot() + -->
<!-- #         labs(x = variavelDependente, -->
<!-- #              y = atributo, -->
<!-- #              title = "Boxplot", -->
<!-- #              subtitle = paste(atributo, variavelDependente, sep = " vs "), -->
<!-- #              caption = "") + -->
<!-- #         theme_bw()  -->
<!-- #         # facet_wrap(~ atributo2) -->
<!-- #       print(result) -->
<!-- #      } -->
<!-- #     } -->
<!-- #     else{ -->
<!-- #       result = ggplot(data = dtAmostra, aes_string(variavelDependente, atributo)) + -->
<!-- #         geom_boxplot() + -->
<!-- #         labs(x = variavelDependente, -->
<!-- #              y = atributo, -->
<!-- #              title = "Boxplot", -->
<!-- #              subtitle = paste(atributo, variavelDependente, sep = " vs "), -->
<!-- #              caption = "") + -->
<!-- #         theme_bw()  -->
<!-- #         # facet_wrap(~ atributo2) -->
<!-- #       print(result)       -->
<!-- #     } -->
<!-- #   } -->
<!-- # } -->
<!-- #  -->
<!-- # box_plot(credit, variaveis1, NULL) -->
<!-- # variaveisIniciais -->
<!-- # box_plot(credit, copiaVariaveis1Winsored, NULL) -->
<!-- # box_plot(credit, c("winsored_Aplicacao"), variaveisSubgrupo) -->
<!-- # box_plot(credit, c("winsored_Movimentacoes_PERC"), variaveisSubgrupo) -->
<!-- # box_plot(credit, c("winsored_Movimentacoes"), variaveisSubgrupo) -->
<!-- # box_plot(credit, c("Produtos_Qualificados"), variaveisSubgrupo) -->
<!-- # box_plot(credit, c("winsored_Rentabilidade"), variaveisSubgrupo) -->

